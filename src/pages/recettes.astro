---
import MainLayout from '../layouts/MainLayout.astro';
import RecipeFilters from '../components/RecipeFilters.astro';
import EnhancedRecipeCard from '../components/EnhancedRecipeCard.astro';
import MicroInteractions from '../components/MicroInteractions.astro';
import SpacingOptimizer from '../components/SpacingOptimizer.astro';
import ShoppingList from '../components/ShoppingList.astro';
import FavoritesManager from '../components/FavoritesManager.astro';
import AnimationOptimizer from '../components/AnimationOptimizer.astro';
import { getRecipesData, type RecipeData } from '../lib/sanity';

// R√©cup√©rer les recettes depuis Sanity
const recipes = await getRecipesData();

// R√©cup√©rer les param√®tres de filtrage depuis l'URL
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('search') || '';
const selectedCategory = url.searchParams.get('category') || '';
const selectedDifficulty = url.searchParams.get('difficulty') || '';
const selectedTime = url.searchParams.get('time') || '';
const selectedBudget = url.searchParams.get('budget') || '';
const selectedSort = url.searchParams.get('sort') || '';
const tagsParam = url.searchParams.get('tags') || url.searchParams.getAll('tags').join(',');
const selectedTags = (tagsParam || '').split(',').filter(Boolean);
const selectedDiet = (url.searchParams.get('diet') || '').split(',').filter(Boolean);
const selectedSeason = (url.searchParams.get('season') || '').split(',').filter(Boolean);

// Pour le filtrage dynamique, on passe toutes les recettes au composant
const allRecipes = recipes;

// Fonction pour obtenir le nom de la cat√©gorie
function getCategoryName(category: string): string {
  const categories: { [key: string]: string } = {
    'entree': 'Entr√©e',
    'plat': 'Plat principal',
    'dessert': 'Dessert',
    'boisson': 'Boisson',
    'accompagnement': 'Accompagnement'
  };
  return categories[category] || category;
}

function normalizeString(value?: string | null): string {
  return (value ?? '')
    .toString()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .trim();
}

function normalizeCategoryValue(category?: string | null): string {
  const normalized = normalizeString(category);
  const aliases: Record<string, string[]> = {
    entree: ['entree', 'entrees', 'entr√©e', 'entr√©es'],
    plat: ['plat', 'plats', 'plat principal', 'plats principaux'],
    dessert: ['dessert', 'desserts'],
    boisson: ['boisson', 'boissons'],
    accompagnement: ['accompagnement', 'accompagnements']
  };

  for (const [value, variants] of Object.entries(aliases)) {
    if (variants.some((variant) => normalizeString(variant) === normalized)) {
      return value;
    }
  }

  return category;
}

// Extraire tous les tags uniques de toutes les recettes
const allTags = new Set<string>();
allRecipes.forEach(recipe => {
  if (recipe.tags) {
    recipe.tags.forEach(tag => allTags.add(tag));
  }
});
const uniqueTags = Array.from(allTags).sort();

const allDiets = new Set<string>();
allRecipes.forEach(recipe => {
  if (recipe.diet) {
    recipe.diet.forEach(diet => allDiets.add(diet));
  }
});

const allSeasons = new Set<string>();
allRecipes.forEach(recipe => {
  if (recipe.season) {
    recipe.season.forEach(season => allSeasons.add(season));
  }
});

const allBudgets = new Set<string>();
allRecipes.forEach(recipe => {
  if (recipe.budget) {
    allBudgets.add(recipe.budget);
  }
});

const categoryCounts = new Map<string, number>();
allRecipes.forEach(recipe => {
  if (!recipe.category) return;
  const normalizedCategory = normalizeCategoryValue(recipe.category);
  categoryCounts.set(normalizedCategory, (categoryCounts.get(normalizedCategory) || 0) + 1);
});

const categories = Array.from(categoryCounts.entries())
  .map(([value, count]) => ({
    value,
    label: getCategoryName(value),
    count
  }))
  .sort((a, b) => a.label.localeCompare(b.label));

const dietLabels: { [key: string]: string } = {
  'vegetarien': 'V√©g√©tarien',
  'vegan': 'Vegan',
  'pescetarien': 'Pesc√©tarien',
  'sans-gluten': 'Sans gluten',
  'sans-lactose': 'Sans lactose',
  'sans-sucre': 'Sans sucre raffin√©',
  'ig-bas': 'IG bas'
};

const seasonLabels: { [key: string]: string } = {
  'printemps': 'Printemps',
  'ete': '√ât√©',
  'automne': 'Automne',
  'hiver': 'Hiver'
};

const budgetLabels: { [key: string]: string } = {
  'economique': '√âconomique',
  'intermediaire': 'Interm√©diaire',
  'genereux': 'G√©n√©reux'
};

const availableDiets = Array.from(allDiets)
  .map(value => ({ value, label: dietLabels[value] || value }))
  .sort((a, b) => a.label.localeCompare(b.label));

const availableSeasons = Array.from(allSeasons)
  .map(value => ({ value, label: seasonLabels[value] || value }))
  .sort((a, b) => a.label.localeCompare(b.label));

const budgets = Array.from(allBudgets)
  .map(value => ({ value, label: budgetLabels[value] || value }))
  .sort((a, b) => a.label.localeCompare(b.label));

// Pr√©parer les donn√©es pour les composants
const recipeCardsData = allRecipes.map(recipe => ({
  id: recipe._id,
  slug: recipe.slug?.current || recipe._id,
  title: recipe.title,
  description: recipe.description,
  image: recipe.featuredImageUrl ? `${recipe.featuredImageUrl}?w=400&h=300&fit=crop&auto=format` : undefined,
  prepTime: recipe.prepTime,
  cookTime: recipe.cookTime,
  restTime: recipe.restTime,
  servings: recipe.servings,
  difficulty: recipe.difficulty,
  category: getCategoryName(normalizeCategoryValue(recipe.category)),
  categoryValue: normalizeCategoryValue(recipe.category),
  rating: recipe.rating,
  isNew: recipe.isNew || false,
  isPopular: recipe.isPopular || false,
  tags: recipe.tags,
  ingredients: recipe.ingredients ? recipe.ingredients.map(ing => ing.name) : []
}));

const recipesIndex = allRecipes.map(recipe => ({
  id: recipe._id,
  slug: recipe.slug?.current || recipe._id,
  title: recipe.title,
  description: recipe.description,
  category: normalizeCategoryValue(recipe.category),
  difficulty: recipe.difficulty,
  prepTime: recipe.prepTime || 0,
  cookTime: recipe.cookTime || 0,
  restTime: recipe.restTime || 0,
  servings: recipe.servings,
  rating: recipe.rating || 0,
  isNew: recipe.isNew || false,
  isPopular: recipe.isPopular || false,
  publishedAt: recipe.publishedAt,
  tags: recipe.tags || [],
  diet: recipe.diet || [],
  season: recipe.season || [],
  budget: recipe.budget || '',
  ingredients: recipe.ingredients || []
}));


---

<MainLayout title="Recettes - Gastronomade">
  <!-- Optimisation d'espacement et micro-interactions -->
  <SpacingOptimizer enableResponsiveSpacing={true} enableDynamicSpacing={true} />
  <MicroInteractions enableHoverEffects={true} enableClickFeedback={true} enableScrollAnimations={true} enableLoadingAnimations={true} />
  <AnimationOptimizer enablePerformanceMode={true} enableReducedMotion={true} />
  <FavoritesManager />
  <ShoppingList />

  <!-- Recipes Section -->
  <section class="py-0 bg-white scroll-fade-in">
    <div class="mv-container">
      <!-- Recipe Filters -->
      <RecipeFilters
        currentFilters={{
          search: searchQuery,
          category: selectedCategory,
          difficulty: selectedDifficulty,
          time: selectedTime,
          budget: selectedBudget,
          tags: selectedTags,
          diet: selectedDiet,
          season: selectedSeason,
          sort: selectedSort
        }}
        availableTags={uniqueTags}
        availableDiets={availableDiets}
        availableSeasons={availableSeasons}
        categories={categories}
        budgets={budgets}
        totalRecipes={allRecipes.length}
      />

      {allRecipes && allRecipes.length > 0 ? (
        <!-- Enhanced Recipes Grid -->
        <div id="recipes-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-7" role="grid">
          {recipeCardsData.map((recipe, index) => (
            <div
              class={`scroll-fade-in ${index % 2 === 0 ? 'scroll-slide-in-left' : 'scroll-slide-in-right'}`}
              style={`animation-delay: ${index * 0.1}s`}
              data-recipe-card
              data-recipe-id={recipe.id}
            >
              <EnhancedRecipeCard
                recipe={recipe}
                showFavoriteButton={true}
                showShoppingListButton={true}
                compact={false}
              />
            </div>
          ))}
        </div>

        <div id="recipes-empty" class="hidden text-center py-12">
          <div class="max-w-xl mx-auto">
            <p class="text-lg font-medium text-mv-forest mb-2">Aucune recette ne correspond √† ces filtres.</p>
            <p class="text-sm text-mv-forest-70">Essayez d'√©largir votre recherche ou de r√©initialiser les filtres.</p>
          </div>
        </div>
      ) : (
        <!-- Recipes Coming Soon -->
        <div class="text-center py-16 scroll-fade-in">
          <div class="max-w-2xl mx-auto">
            <svg class="mx-auto h-24 w-24 text-mv-forest-80 mb-8" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <h2 class="text-3xl font-serif font-bold text-mv-forest mb-4">
              Recettes √† venir
            </h2>
            <p class="text-lg text-mv-forest-80 mb-8">
              Je pr√©pare une collection de recettes saines et d√©licieuses pour vous accompagner dans votre voyage culinaire.
            </p>
          <div class="bg-mv-cream rounded-lg p-6 inline-block border border-mv-leaf-20">
              <p class="text-mv-forest-80">
                <strong>Prochainement :</strong> Recettes connect√©es au CMS pour une exp√©rience interactive
              </p>
            </div>
          </div>
        </div>

        <!-- Recipe Preview Cards -->
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mt-12">
          <!-- Recipe Card 1 -->
          <div class="mv-card overflow-hidden hover-lift click-feedback">
            <div class="aspect-video bg-mv-cream flex items-center justify-center">
              <div class="text-center text-mv-forest-60">
                <svg class="mx-auto h-12 w-12 mb-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p class="text-sm">Photo recette</p>
              </div>
            </div>
            <div class="p-6">
              <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
                Salade d'√©t√© aux herbes
              </h3>
              <p class="text-mv-forest-80 mb-4">
                Une salade fra√Æche et l√©g√®re, parfaite pour les journ√©es ensoleill√©es.
              </p>
              <div class="flex items-center justify-between text-sm text-mv-forest-60 mb-4">
                <span>‚è±Ô∏è 15 min</span>
                <span>üë• 4 pers.</span>
                <span>üìä Facile</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 bg-mv-forest text-white text-xs rounded-full">V√©g√©tarien</span>
                <span class="px-2 py-1 bg-mv-cream text-mv-forest text-xs rounded-full">Rapide</span>
              </div>
            </div>
          </div>

          <!-- Recipe Card 2 -->
          <div class="mv-card overflow-hidden hover-lift click-feedback">
            <div class="aspect-video bg-gray-200 flex items-center justify-center">
              <div class="text-center text-mv-forest-60">
                <svg class="mx-auto h-12 w-12 mb-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p class="text-sm">Photo recette</p>
              </div>
            </div>
            <div class="p-6">
              <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
                Soupe de l√©gumes d'automne
              </h3>
              <p class="text-mv-forest-70 mb-4">
                Un velout√© r√©confortant aux saveurs d'automne, riche en nutriments.
              </p>
              <div class="flex items-center justify-between text-sm text-mv-forest-60 mb-4">
                <span>‚è±Ô∏è 45 min</span>
                <span>üë• 6 pers.</span>
                <span>üìä Moyen</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 bg-mv-forest text-white text-xs rounded-full">V√©g√©tarien</span>
                <span class="px-2 py-1 bg-mv-leaf text-white text-xs rounded-full">Thermomix</span>
              </div>
            </div>
          </div>

          <!-- Recipe Card 3 -->
          <div class="mv-card overflow-hidden hover-lift click-feedback">
            <div class="aspect-video bg-gray-200 flex items-center justify-center">
              <div class="text-center text-mv-forest-60">
                <svg class="mx-auto h-12 w-12 mb-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <p class="text-sm">Photo recette</p>
              </div>
            </div>
            <div class="p-6">
              <h3 class="text-xl font-serif font-bold text-mv-forest mb-2">
                Quinoa aux l√©gumes grill√©s
              </h3>
              <p class="text-mv-forest-70 mb-4">
                Un plat complet et √©quilibr√©, source de prot√©ines v√©g√©tales.
              </p>
              <div class="flex items-center justify-between text-sm text-mv-forest-60 mb-4">
                <span>‚è±Ô∏è 30 min</span>
                <span>üë• 4 pers.</span>
                <span>üìä Facile</span>
              </div>
              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-1 bg-mv-forest text-white text-xs rounded-full">V√©g√©tarien</span>
                <span class="px-2 py-1 bg-mv-cream text-mv-forest text-xs rounded-full">Rapide</span>
                <span class="px-2 py-1 bg-mv-leaf text-white text-xs rounded-full">Saison</span>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  </section>

  <script define:vars={{ recipesIndex }}>
    window.recipeIndex = recipesIndex;
  </script>
</MainLayout>
